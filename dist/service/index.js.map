{"version":3,"sources":["../../src/service/index.js"],"names":["Service","Config","bayes","firebase","initializeApp","credential","cert","FIREBASE_SERVICE_ACCOUNT","databaseURL","FIREBASE_URL","_firebase","_classifier","prototype","createModel","model","callback","database","ref","push","then","response","key","catch","err","addModelTrainingItem","modelId","item","child","set","res","clearModelTrainingItems","deleteItems","items","forEach","once","snaps","snapshotsList","snapshots","clientInstagramSnapshots","snapshotLength","numChildren","on","snap","snapshotSnap","length","getModelTrainingItems","val","getModels","modelsSnap","getModel","modelSnap","classify","itemText","classifierJsonSnap","_trainedClassifier","fromJson","text","classification","categorize","probability","probabilities","getClassifier","testModel","percentage","correctResults","incorrectResults","modelTrainingItems","itemsCount","toFixed","x","itemsTested","accuracy","trainModel","learn","toJson","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["import firebase from 'firebase-admin';\n\nfunction Service(Config, bayes) {\n\n  firebase.initializeApp({\n    credential: firebase.credential.cert(Config.FIREBASE_SERVICE_ACCOUNT),\n    databaseURL: Config.FIREBASE_URL\n  });\n\n  const _firebase = firebase;\n  const _classifier = bayes();\n\n  /**\n   * Creates a new model and saves it to the database\n   *\n   * @param  {Object} model Object of the model including name (string)\n   * @return {firebase UID} ID of the firebase model\n   */\n  Service.prototype.createModel = (model, callback) => {\n    _firebase.database().ref('models/').push(model).then(function (response) {\n      callback(response.key);\n    }).catch(function (err) {\n      callback(false);\n    });\n  },\n\n    /**\n     * Creates a new, pre-trained item and saves it to the database\n     *\n     * @param  {firebase UID} modelId of the model to add the training item to\n     * @param  {Object} model Object of the model including name (string)\n     * @return {firebase UID} ID of the firebase model\n     */\n    Service.prototype.addModelTrainingItem = (modelId, item, callback) => {\n      _firebase.database().ref('modelTrainingItems/').push(item).then(function (response) {\n        _firebase.database().ref('models/' + modelId + '/modelTrainingItems/').child(response.key).set(true).then(function (res) {\n          callback(response.key);\n        }).catch(function (err) {\n          callback(false);\n        });\n      });\n    },\n\n    /**\n     * Deletes all pre-trained items for a particular model\n     *\n     * @param  {firebase UID} modelId of the model\n     * @param  {Object} model Object of the model including name (string)\n     * @return {boolean} operation completed successfully\n     */\n    Service.prototype.clearModelTrainingItems = (modelId, callback) => {\n      function deleteItems(items) {\n        items.forEach(function (item) {\n          _firebase.database().ref('models/' + modelId + '/modelTrainingItems/').child(item.key).set(null).then(function () {\n            _firebase.database().ref('/modelTrainingItems/').child(item.key).set(null).then(function (response) {\n              callback(true);\n            }).catch(function (err) {\n              callback(false);\n            });\n          }).catch(function (err) {\n            callback(false);\n          });\n        });\n      }\n\n      _firebase.database().ref('models/' + modelId + '/modelTrainingItems/').once('value', function (snaps) {\n        var snapshotsList = [];\n        var snapshots = _firebase.database().ref('modelTrainingItems');\n        var clientInstagramSnapshots = _firebase.database().ref('models/' + modelId + '/modelTrainingItems/');\n        var snapshotLength = snaps.numChildren();\n        clientInstagramSnapshots.on('child_added', function (snap) {\n          snapshots.child(snap.key).once('value', function (snapshotSnap) {\n            snapshotsList.push(snapshotSnap);\n            if (snapshotsList.length === snapshotLength) {\n              deleteItems(snapshotsList);\n            }\n          });\n        });\n      });\n    },\n\n    /**\n     * Retreives an array of pre-trained items for a model\n     *\n     * @param  {firebase UID} modelId of the model\n     * @return {Array [Object]} Array of pre-trained items\n     */\n    Service.prototype.getModelTrainingItems = (modelId, callback) => {\n      _firebase.database().ref('models/' + modelId + '/modelTrainingItems/').once('value', function (snaps) {\n        var snapshotsList = [];\n        var snapshots = _firebase.database().ref('modelTrainingItems');\n        var clientInstagramSnapshots = _firebase.database().ref('models/' + modelId + '/modelTrainingItems/');\n        var snapshotLength = snaps.numChildren();\n        clientInstagramSnapshots.on('child_added', function (snap) {\n          snapshots.child(snap.key).once('value', function (snapshotSnap) {\n            snapshotsList.push(snapshotSnap.val());\n            if (snapshotsList.length === snapshotLength) {\n              callback(snapshotsList);\n            }\n          });\n        });\n      });\n    },\n\n\n    /**\n     * Retreives an array of models\n     *\n     * @return {Array [Object]} Array of models\n     */\n    Service.prototype.getModels = (callback) => {\n      _firebase.database().ref('models').once('value', function (modelsSnap) {\n        callback(modelsSnap.val());\n      });\n    },\n\n    /**\n     * Retreives a model by it's Id\n     *\n     * @param  {firebase UID} modelId of the model\n     * @return {Object} Model\n     */\n    Service.prototype.getModel = (modelId, callback) => {\n      _firebase.database().ref('models/' + modelId).once('value', function (modelSnap) {\n        callback(modelSnap.val());\n      });\n    },\n\n    /**\n     * Classify an item using a specific model\n     *\n     * @param  {firebase UID} modelId of the model\n     * @param  {string} itemText string to classify\n     * @return {Object} classification\n     */\n    Service.prototype.classify = (modelId, itemText, callback) => {\n      _firebase.database().ref('models/' + modelId + '/classifierJson').once('value', function (classifierJsonSnap) {\n        const _trainedClassifier = bayes.fromJson(classifierJsonSnap.val());\n        callback(\n          {\n            text: itemText,\n            classification: _trainedClassifier.categorize(itemText)\n          });\n      });\n    },\n\n    /**\n     * Classify an item using a specific model\n     *\n     * @param  {firebase UID} modelId of the model\n     * @param  {string} itemText string to classify\n     * @return {Object} probability\n     */\n    Service.prototype.probability = (modelId, itemText, callback) => {\n      _firebase.database().ref('models/' + modelId + '/classifierJson').once('value', function (classifierJsonSnap) {\n        const _trainedClassifier = bayes.fromJson(classifierJsonSnap.val());\n        callback(\n          {\n            text: itemText,\n            classification: _trainedClassifier.probabilities(itemText)\n          });\n      });\n    },\n\n    /**\n    * Get Classifier from DB\n    *\n    * @param  {firebase UID} modelId of the model\n    * @return {Object} classifier\n    */\n    Service.prototype.getClassifier = (modelId, callback) => {\n      _firebase.database().ref('models/' + modelId + '/classifierJson').once('value', function (classifierJsonSnap) {\n        callback(classifierJsonSnap.val());\n      });\n    },\n\n    /**\n    * Loads a model from the saved Json Classifier, then runs 15% of pre-trained items to test accuracy\n    *\n    * @param  {firebase UID} modelId of the model\n    * @param  {number} percentage of items to test, default to 15%\n    * @return {number} accuracy %\n    */\n    Service.prototype.testModel = (modelId, percentage, callback) => {\n      let correctResults = 0;\n      let incorrectResults = 0;\n      // Load the saved Json Classifier for the model\n      _firebase.database().ref('models/' + modelId + '/classifierJson').once('value', function (classifierJsonSnap) {\n        const _trainedClassifier = bayes.fromJson(classifierJsonSnap.val());\n        // Grab items to test\n        Service.prototype.getModelTrainingItems(modelId, function (modelTrainingItems) {\n          const itemsCount = (modelTrainingItems.length * (percentage / 100)).toFixed();\n          // Foreach item, test it and compare against its pre-trained classifications\n          for (var x = 0; x < itemsCount; x++) {\n            if (_trainedClassifier.categorize(modelTrainingItems[x].text) === modelTrainingItems[x].classification) {\n              correctResults++\n            } else {\n              incorrectResults++\n            }\n          }\n          callback({\n            itemsTested: itemsCount,\n            accuracy: (correctResults / (itemsCount) * 100).toFixed(2)\n          });\n        });\n      });\n    }\n\n  /**\n   * Train a model with it's pre-trained items and save its classifier to Json in the database\n   *\n   * @param  {firebase UID} modelId of the model\n   * @return {boolean} operation completed\n   */\n  Service.prototype.trainModel = (modelId, callback) => {\n    Service.prototype.getModelTrainingItems(modelId, function (modelTrainingItems) {\n      for (var x = 0; x < modelTrainingItems.length; x++) {\n        _classifier.learn(modelTrainingItems[x].text, modelTrainingItems[x].classification);\n      }\n      //Save classifier to Json\n      _firebase.database().ref('models/' + modelId).child('classifierJson').set(_classifier.toJson()).then(function (response) {\n        callback(true);\n      }).catch(function (err) {\n        callback(false);\n      });\n    });\n  }\n\n}\n\nmodule.exports = Service;"]}